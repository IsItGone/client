<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IsItGone Map</title>
    <style>
      body {
        margin: 0;
      }
    </style>
    <script>
      function getQueryParams() {
        const params = {};
        window.location.search
          .substring(1)
          .split("&")
          .forEach((pair) => {
            const [key, value] = pair.split("=");
            params[decodeURIComponent(key)] = decodeURIComponent(value);
          });
        return params;
      }

      const params = getQueryParams();
      const clientId = params["clientId"];
      document.write(`
        <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=${clientId}&callback=initMap"><\/script>
      `);
    </script>
  </head>
  <body>
    <div id="map" style="width: 100%; height: 100vh"></div>
    <!-- <div class="input-contianer">
      <div style="height: 200px"></div>
      <input type="text" class="text-input" id="text-input" placeholder=" " />
      <button class="button">전송</button>
      <p id="message" style="font-size: 15px">메시지가 여기에 표시됩니다.</p>
    </div> -->
    <script id="code">
      window.addEventListener("message", function (event) {
        try {
          const parsedData = JSON.parse(event.data);
          drawRoutes(parsedData.data.routes, parsedData.data.colors);
        } catch (e) {
          console.error("Invalid JSON received:", e);
        }
      });

      var map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(36.3553177, 127.2981911), // 대전 삼성화재 연수원
        mapTypeId: naver.maps.MapTypeId.NORMAL,
      });

      // ////////////////////////////////////////////////

      var infoWindow = new naver.maps.InfoWindow();

      var pinkMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(36.3553177, 127.2981911),
        map: map,
        icon: {
          url: "assets/icons/bus_station_icon_sm.png",
        },
      });
      pinkMarker.setTitle("Pink Marker");
      naver.maps.Event.addListener(pinkMarker, "click", function () {
        infoWindow.setContent(getContentElement("HTML MARKER"));
        infoWindow.open(map, pinkMarker);
      });

      function drawRoutes(routesData, colorsData) {
        routesData.forEach((route, index) => {
          const path = [];

          // departureStations의 좌표를 path에 추가
          route.departureStations.forEach((station) => {
            path.push({ lat: station.latitude, lng: station.longitude });
          });

          // arrivalStations의 좌표를 path에 추가
          route.arrivalStations.forEach((station) => {
            path.push({ lat: station.latitude, lng: station.longitude });
          });

          const polyline = new naver.maps.Polyline({
            path: path,
            strokeColor: "#" + colorsData[index].substring(2, 8),
            strokeOpacity: 0.8,
            strokeWeight: 6,
            zIndex: 2,
            clickable: true,
            map: map,
          });

          naver.maps.Event.addListener(polyline, "mousedown", function () {
            polyline.setOptions({
              strokeWeight: 20,
            });
          });

          naver.maps.Event.addListener(polyline, "mouseup", function () {
            polyline.setOptions({
              strokeWeight: 6,
            });
          });

          naver.maps.Event.addListener(polyline, "click", function () {
            alert("polyline click");
          });
        });
      }
      // /////////////////////////////////////////////////////////

      // var infowindow = new naver.maps.InfoWindow();

      function onSuccessGeolocation(position) {
        var location = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);

        map.setCenter(location); // 얻은 좌표를 지도의 중심으로 설정합니다.

        // infowindow.setContent(
        //   '<div style="padding:20px;">' + "geolocation.getCurrentPosition() 위치" + "</div>"
        // );

        // infowindow.open(map, location);
        // console.log("Coordinates: " + location.toString());
      }

      function onErrorGeolocation() {
        var center = map.getCenter();

        // infowindow.setContent(
        //   '<div style="padding:20px;">' +
        //     '<h5 style="margin-bottom:5px;color:#f00;">Geolocation failed!</h5>' +
        //     "latitude: " +
        //     center.lat() +
        //     "<br />longitude: " +
        //     center.lng() +
        //     "</div>"
        // );

        // infowindow.open(map, center);
      }

      window.addEventListener("load", function () {
        console.log(navigator.geolocation);
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(onSuccessGeolocation, onErrorGeolocation);
        } else {
          // var center = map.getCenter();
          // infowindow.setContent(
          //   '<div style="padding:20px;"><h5 style="margin-bottom:5px;color:#f00;">Geolocation not supported</h5></div>'
          // );
          // infowindow.open(map, center);
        }
      });
    </script>
  </body>
</html>
